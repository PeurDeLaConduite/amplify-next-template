version: 1

backend:
    phases:
        build:
            commands:
                - nvm install 22.14.0
                - nvm use 22.14.0
                - corepack enable
                - corepack prepare yarn@4.9.2 --activate
                - yarn cache clean
                - yarn install --immutable
                - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID

frontend:
    phases:
        preBuild:
            commands:
                - export NODE_OPTIONS="--max-old-space-size=4096" # ↑ mémoire pour tsc/eslint/next
                - export NEXT_TELEMETRY_DISABLED=1
                - export NEXT_WORKER_CONCURRENCY=1 # ↓ workers pour limiter la RAM
                - export NEXT_DISABLE_ESLINT=1 # on lint séparément
                # (optionnel) sourcemaps prod off pour réduire la charge
                - export NEXT_DISABLE_SOURCEMAPS=1
        build:
            commands:
                # 1) Type-check (tombe la build si erreurs)
                - yarn tsc --noEmit
                # 2) Lint (tombe la build si warnings -> ajuste si besoin)
                - yarn eslint . --max-warnings=0 --cache
                # 3) Build Next sans relancer eslint/type-check
                - yarn next build

    artifacts:
        baseDirectory: .next
        files:
            - "**/*"

    cache:
        paths:
            - .next/cache/**/*
            - .npm/**/*
            - node_modules/**/*

    customHeaders:
        - pattern: "/img/**"
          headers:
              - key: "Cache-Control"
                value: "public, max-age=31536000, immutable"
